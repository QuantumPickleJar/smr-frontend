import{G as X,S as Se,i as Pe,d as j,s as Ie,y as Ee,I as Ve,v as Re,F as se,a0 as Q,a1 as W,_ as ae,w as J,H as ce,$ as Ne,f as K,b as A,e as I,W as B,J as te,K as Te,j as h,k as z,g as E,h as N,X as C,L as ne,N as D,m as V,Q as P,n as T,O as oe,r as F,t as O,q as le,T as _e,R as re,p as fe,Y as L,u as G,M as je,l as ue}from"../chunks/vendor.b1090c37.js";import{T as he}from"../chunks/Toast.c66ddab3.js";import{V as ge}from"../chunks/VersionForm.e7653a56.js";import{u as De,F as Be,v as Ce,w as Fe,x as de}from"../chunks/graphql.fef59309.js";import{M as $e}from"../chunks/MetaDescriptors.cb11bfd0.js";const Me=async({params:n})=>({...n}),He=Object.freeze(Object.defineProperty({__proto__:null,load:Me},Symbol.toStringTag,{value:"Module"})),me=async(n,e,r,s,i)=>{const a=Math.ceil(n.size/1e7),f=new Array(a).fill(0).map((m,l)=>l).reverse(),o=(m,l,w)=>i.mutation(Fe,{modId:e,versionId:w,part:l,file:m}).toPromise(),p=10;let $=0,g=0;const x=m=>{if($>=p||!f.length)return;const l=f.pop(),w=l*1e7,v=n.slice(w,w+1e7);return $+=1,Promise.all([o(v,l+1,m).then(()=>($-=1,s.set({total:a,uploaded:a-f.length-$}),x(m))).catch(d=>{if(console.error("Upload failed:",d),$-=1,f.push(l),g+=1,g<5)return x(m);throw new Error("Failed uploading after 5 attempts")}),x(m)])};return i.mutation(De,{modId:e}).toPromise().then(async m=>(s.set({total:a,uploaded:0}),await x(m.data.createVersion),m.data.createVersion)).then(m=>(console.log("Finalizing",{versionID:m}),i.mutation(Be,{modId:e,versionId:m,version:r}).toPromise().then(()=>new Promise((l,w)=>{let v=0,d=X({query:Ce,client:i,variables:{modId:e,versionId:m},requestPolicy:"network-only"});const b=setInterval(()=>{if(v==60)return clearInterval(b),w(new Error("Timed out waiting for mod processing"));d.pause(),d.resume(),v++},1e4),y=d.subscribe(c=>{if(!c.fetching){if(c.error){clearInterval(b),w(new Error(c.error.message)),setTimeout(y);return}c.data?.checkVersionUploadState?.version?.id&&(y(),clearInterval(b),l(c.data.checkVersionUploadState))}})})))).catch(m=>{throw console.error(m),m})},{console:pe}=Ne,R="src/routes/mod/[modId]/new-version/+page.svelte";function Y(n){let e,r;e=new $e({props:{description:"Creating a new version of mod "+n[2].data.mod.name,title:"New version of mod "+n[2].data.mod.name},$$inline:!0});const s={c:function(){te(e.$$.fragment)},l:function(t){ne(e.$$.fragment,t)},m:function(t,a){oe(e,t,a),r=!0},p:function(t,a){const f={};a&4&&(f.description="Creating a new version of mod "+t[2].data.mod.name),a&4&&(f.title="New version of mod "+t[2].data.mod.name),e.$set(f)},i:function(t){r||(F(e.$$.fragment,t),r=!0)},o:function(t){O(e.$$.fragment,t),r=!1},d:function(t){re(e,t)}};return j("SvelteRegisterBlock",{block:s,id:Y.name,type:"if",source:"(59:2) {#if !$mod.fetching && !$mod.error && $mod.data.mod}",ctx:n}),s}function ve(n){let e=n[2].data.mod.name+"",r;const s={c:function(){r=B(e)},l:function(t){r=C(t,e)},m:function(t,a){T(t,r,a)},p:function(t,a){a&4&&e!==(e=t[2].data.mod.name+"")&&L(r,e)},d:function(t){t&&h(r)}};return j("SvelteRegisterBlock",{block:s,id:ve.name,type:"if",source:"(70:24) ",ctx:n}),s}function we(n){let e;const r={c:function(){e=B("...")},l:function(i){e=C(i,"...")},m:function(i,t){T(i,e,t)},p:G,d:function(i){i&&h(e)}};return j("SvelteRegisterBlock",{block:r,id:we.name,type:"if",source:"(68:2) {#if $mod.fetching}",ctx:n}),r}function xe(n){let e,r,s,i;e=new ge({props:{onSubmit:n[8],modReference:n[2].data.mod.mod_reference},$$inline:!0});let t=n[3]&&Z(n);const a={c:function(){te(e.$$.fragment),r=A(),t&&t.c(),s=K()},l:function(o){ne(e.$$.fragment,o),r=z(o),t&&t.l(o),s=K()},m:function(o,p){oe(e,o,p),T(o,r,p),t&&t.m(o,p),T(o,s,p),i=!0},p:function(o,p){const $={};p&4&&($.modReference=o[2].data.mod.mod_reference),e.$set($),o[3]?t?t.p(o,p):(t=Z(o),t.c(),t.m(s.parentNode,s)):t&&(t.d(1),t=null)},i:function(o){i||(F(e.$$.fragment,o),i=!0)},o:function(o){O(e.$$.fragment,o),i=!1},d:function(o){o&&(h(r),h(s)),re(e,o),t&&t.d(o)}};return j("SvelteRegisterBlock",{block:a,id:xe.name,type:"else",source:"(81:4) {:else}",ctx:n}),a}function be(n){let e,r,s=n[2].error.message+"",i;const t={c:function(){e=I("p"),r=B("Oh no... "),i=B(s),this.h()},l:function(f){e=E(f,"P",{});var o=N(e);r=C(o,"Oh no... "),i=C(o,s),o.forEach(h),this.h()},h:function(){V(e,R,98,6,2348)},m:function(f,o){T(f,e,o),P(e,r),P(e,i)},p:function(f,o){o&4&&s!==(s=f[2].error.message+"")&&L(i,s)},i:G,o:G,d:function(f){f&&h(e)}};return j("SvelteRegisterBlock",{block:t,id:be.name,type:"if",source:"(79:25) ",ctx:n}),t}function ye(n){let e,r="Loading...";const s={c:function(){e=I("p"),e.textContent=r,this.h()},l:function(t){e=E(t,"P",{"data-svelte-h":!0}),je(e)!=="svelte-qdsr2u"&&(e.textContent=r),this.h()},h:function(){V(e,R,96,6,2298)},m:function(t,a){T(t,e,a)},p:G,i:G,o:G,d:function(t){t&&h(e)}};return j("SvelteRegisterBlock",{block:s,id:ye.name,type:"if",source:"(77:4) {#if $mod.fetching}",ctx:n}),s}function Z(n){let e,r,s,i,t,a,f,o,p=n[4].toFixed(0)+"",$,g,x,m,l;const w={c:function(){e=I("div"),r=I("div"),s=I("div"),i=I("span"),t=B(n[3]),a=A(),f=I("div"),o=I("span"),$=B(p),g=B("%"),x=A(),m=I("div"),l=I("div"),this.h()},l:function(d){e=E(d,"DIV",{class:!0});var b=N(e);r=E(b,"DIV",{class:!0});var y=N(r);s=E(y,"DIV",{});var c=N(s);i=E(c,"SPAN",{class:!0});var _=N(i);t=C(_,n[3]),_.forEach(h),c.forEach(h),a=z(y),f=E(y,"DIV",{class:!0});var H=N(f);o=E(H,"SPAN",{class:!0});var q=N(o);$=C(q,p),g=C(q,"%"),q.forEach(h),H.forEach(h),y.forEach(h),x=z(b),m=E(b,"DIV",{class:!0});var k=N(m);l=E(k,"DIV",{style:!0,class:!0}),N(l).forEach(h),k.forEach(h),b.forEach(h),this.h()},h:function(){D(i,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),V(i,R,106,14,2631),V(s,R,105,12,2611),D(o,"class","text-xs font-semibold inline-block text-white"),V(o,R,112,14,2879),D(f,"class","text-right"),V(f,R,111,12,2840),D(r,"class","flex mb-2 items-center justify-between"),V(r,R,104,10,2546),ue(l,"width",n[4].toFixed(0)+"%"),D(l,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),V(l,R,116,12,3105),D(m,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),V(m,R,115,10,3021),D(e,"class","relative pt-4"),V(e,R,103,8,2508)},m:function(d,b){T(d,e,b),P(e,r),P(r,s),P(s,i),P(i,t),P(r,a),P(r,f),P(f,o),P(o,$),P(o,g),P(e,x),P(e,m),P(m,l)},p:function(d,b){b&8&&L(t,d[3]),b&16&&p!==(p=d[4].toFixed(0)+"")&&L($,p),b&16&&ue(l,"width",d[4].toFixed(0)+"%")},d:function(d){d&&h(e)}};return j("SvelteRegisterBlock",{block:w,id:Z.name,type:"if",source:"(84:6) {#if $uploadStatus}",ctx:n}),w}function ke(n){let e,r;const s={c:function(){e=I("span"),r=B(n[1]),this.h()},l:function(t){e=E(t,"SPAN",{});var a=N(e);r=C(a,n[1]),a.forEach(h),this.h()},h:function(){V(e,R,127,2,3400)},m:function(t,a){T(t,e,a),P(e,r)},p:function(t,a){a&2&&L(r,t[1])},d:function(t){t&&h(e)}};return j("SvelteRegisterBlock",{block:s,id:ke.name,type:"slot",source:"(108:0) <Toast bind:running={errorToast}>",ctx:n}),s}function ee(n){let e,r,s,i,t,a,f,o,p,$,g,x,m,l=!n[2].fetching&&!n[2].error&&n[2].data.mod&&Y(n);function w(k,u){if(k[2].fetching)return we;if(!k[2].error)return ve}let v=w(n),d=v&&v(n);const b=[ye,be,xe],y=[];function c(k,u){return k[2].fetching?0:k[2].error?1:2}o=c(n),p=y[o]=b[o](n);function _(k){n[10](k)}let H={$$slots:{default:[ke]},$$scope:{ctx:n}};n[0]!==void 0&&(H.running=n[0]),g=new he({props:H,$$inline:!0}),Ee.push(()=>Ve(g,"running",_));const q={c:function(){l&&l.c(),e=K(),r=A(),s=I("h1"),i=B(`New Version for
  `),d&&d.c(),t=A(),a=I("div"),f=I("section"),p.c(),$=A(),te(g.$$.fragment),this.h()},l:function(u){const S=Te("svelte-nx2zao",document.head);l&&l.l(S),e=K(),S.forEach(h),r=z(u),s=E(u,"H1",{class:!0});var M=N(s);i=C(M,`New Version for
  `),d&&d.l(M),M.forEach(h),t=z(u),a=E(u,"DIV",{class:!0});var U=N(a);f=E(U,"SECTION",{});var ie=N(f);p.l(ie),ie.forEach(h),U.forEach(h),$=z(u),ne(g.$$.fragment,u),this.h()},h:function(){D(s,"class","text-4xl my-4 font-bold"),V(s,R,84,0,2083),V(f,R,94,2,2258),D(a,"class","card p-4"),V(a,R,93,0,2233)},m:function(u,S){l&&l.m(document.head,null),P(document.head,e),T(u,r,S),T(u,s,S),P(s,i),d&&d.m(s,null),T(u,t,S),T(u,a,S),P(a,f),y[o].m(f,null),T(u,$,S),oe(g,u,S),m=!0},p:function(u,[S]){!u[2].fetching&&!u[2].error&&u[2].data.mod?l?(l.p(u,S),S&4&&F(l,1)):(l=Y(u),l.c(),F(l,1),l.m(e.parentNode,e)):l&&(fe(),O(l,1,1,()=>{l=null}),le()),v===(v=w(u))&&d?d.p(u,S):(d&&d.d(1),d=v&&v(u),d&&(d.c(),d.m(s,null)));let M=o;o=c(u),o===M?y[o].p(u,S):(fe(),O(y[M],1,1,()=>{y[M]=null}),le(),p=y[o],p?p.p(u,S):(p=y[o]=b[o](u),p.c()),F(p,1),p.m(f,null));const U={};S&16386&&(U.$$scope={dirty:S,ctx:u}),!x&&S&1&&(x=!0,U.running=u[0],_e(()=>x=!1)),g.$set(U)},i:function(u){m||(F(l),F(p),F(g.$$.fragment,u),m=!0)},o:function(u){O(l),O(p),O(g.$$.fragment,u),m=!1},d:function(u){u&&(h(r),h(s),h(t),h(a),h($)),l&&l.d(u),h(e),d&&d.d(),y[o].d(),re(g,u)}};return j("SvelteRegisterBlock",{block:q,id:ee.name,type:"component",source:"",ctx:n}),q}function Oe(n,e,r){let s,i,t,{$$slots:a={},$$scope:f}=e;Re("Page",a,[]);let{data:o}=e;const{modId:p}=o,$=se(),g=J("");Q(g,"uploadStatus"),W(n,g,c=>r(3,i=c));const x=J(0);Q(x,"uploadPercent"),W(n,x,c=>r(4,t=c));const m=J();m.subscribe(c=>{c&&(c.uploaded===c.total?(g.set("Processing..."),x.set(100)):(g.set(`Uploading: ${c.uploaded}/${c.total}`),x.set(c.uploaded/c.total*100)))});let l="",w=!1;const v=X({query:de,client:$,variables:{mod:p}});Q(v,"mod"),W(n,v,c=>r(2,s=c));const d=async c=>me(c.file,s.data.mod.id,{changelog:c.changelog,stability:c.stability},m,$).then(_=>{console.log({success:_}),ae(ce+"/mod/"+p+"/version/"+_.version.id)}).catch(_=>{console.error(_),r(1,l="Error creating version: "+_.message),r(0,w=!0),g.set("")});n.$$.on_mount.push(function(){o===void 0&&!("data"in e||n.$$.bound[n.$$.props.data])&&pe.warn("<Page> was created without expected prop 'data'")});const b=["data"];Object.keys(e).forEach(c=>{!~b.indexOf(c)&&c.slice(0,2)!=="$$"&&c!=="slot"&&pe.warn(`<Page> was created with unknown prop '${c}'`)});function y(c){w=c,r(0,w)}return n.$$set=c=>{"data"in c&&r(9,o=c.data)},n.$capture_state=()=>({getContextClient:se,queryStore:X,Toast:he,goto:ae,VersionForm:ge,GetModReferenceDocument:de,writable:J,chunkedUpload:me,base:ce,MetaDescriptors:$e,data:o,modId:p,client:$,uploadStatus:g,uploadPercent:x,uploadState:m,errorMessage:l,errorToast:w,mod:v,onSubmit:d,$mod:s,$uploadStatus:i,$uploadPercent:t}),n.$inject_state=c=>{"data"in c&&r(9,o=c.data),"errorMessage"in c&&r(1,l=c.errorMessage),"errorToast"in c&&r(0,w=c.errorToast)},e&&"$$inject"in e&&n.$inject_state(e.$$inject),n.$$.update=()=>{n.$$.dirty&1&&(w||r(1,l=""))},[w,l,s,i,t,g,x,v,d,o,y]}class Le extends Se{constructor(e){super(e),Pe(this,e,Oe,ee,Ie,{data:9}),j("SvelteRegisterComponent",{component:this,tagName:"Page",options:e,id:ee.name})}get data(){throw new Error("<Page>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set data(e){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Le as component,He as universal};
//# sourceMappingURL=17.c5bcd13e.js.map
