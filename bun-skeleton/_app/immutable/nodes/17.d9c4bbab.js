import{G as X,S as Se,i as Pe,d as B,s as Ee,y as Ie,I as Ve,v as Re,F as se,$ as Q,a0 as W,Z as ae,w as J,H as ce,_ as Ne,f as K,b as z,e as E,K as j,J as te,L as Te,j as h,k as A,g as I,h as V,N as D,M as ne,O as F,m as R,R as y,n as T,Q as oe,r as M,t as C,q as le,U as _e,T as re,p as fe,X as H,u as L,l as ue}from"../chunks/vendor.7f7881cb.js";import{T as he}from"../chunks/Toast.94a1f60f.js";import{V as ge}from"../chunks/VersionForm.b56cbfd7.js";import{u as je,F as De,v as Be,w as Fe,x as de}from"../chunks/graphql.fef59309.js";import{M as $e}from"../chunks/MetaDescriptors.3fc0d18e.js";const Me=async({params:n})=>({...n}),Le=Object.freeze(Object.defineProperty({__proto__:null,load:Me},Symbol.toStringTag,{value:"Module"})),me=async(n,e,r,s,i)=>{const a=Math.ceil(n.size/1e7),u=new Array(a).fill(0).map((m,l)=>l).reverse(),o=(m,l,w)=>i.mutation(Fe,{modId:e,versionId:w,part:l,file:m}).toPromise(),p=10;let $=0,g=0;const b=m=>{if($>=p||!u.length)return;const l=u.pop(),w=l*1e7,v=n.slice(w,w+1e7);return $+=1,Promise.all([o(v,l+1,m).then(()=>($-=1,s.set({total:a,uploaded:a-u.length-$}),b(m))).catch(d=>{if(console.error("Upload failed:",d),$-=1,u.push(l),g+=1,g<5)return b(m);throw new Error("Failed uploading after 5 attempts")}),b(m)])};return i.mutation(je,{modId:e}).toPromise().then(async m=>(s.set({total:a,uploaded:0}),await b(m.data.createVersion),m.data.createVersion)).then(m=>(console.log("Finalizing",{versionID:m}),i.mutation(De,{modId:e,versionId:m,version:r}).toPromise().then(()=>new Promise((l,w)=>{let v=0,d=X({query:Be,client:i,variables:{modId:e,versionId:m},requestPolicy:"network-only"});const x=setInterval(()=>{if(v==60)return clearInterval(x),w(new Error("Timed out waiting for mod processing"));d.pause(),d.resume(),v++},1e4),k=d.subscribe(c=>{if(!c.fetching){if(c.error){clearInterval(x),w(new Error(c.error.message)),setTimeout(k);return}c.data?.checkVersionUploadState?.version?.id&&(k(),clearInterval(x),l(c.data.checkVersionUploadState))}})})))).catch(m=>{throw console.error(m),m})},{console:pe}=Ne,N="src/routes/mod/[modId]/new-version/+page.svelte";function Z(n){let e,r;e=new $e({props:{description:"Creating a new version of mod "+n[2].data.mod.name,title:"New version of mod "+n[2].data.mod.name},$$inline:!0});const s={c:function(){te(e.$$.fragment)},l:function(t){ne(e.$$.fragment,t)},m:function(t,a){oe(e,t,a),r=!0},p:function(t,a){const u={};a&4&&(u.description="Creating a new version of mod "+t[2].data.mod.name),a&4&&(u.title="New version of mod "+t[2].data.mod.name),e.$set(u)},i:function(t){r||(M(e.$$.fragment,t),r=!0)},o:function(t){C(e.$$.fragment,t),r=!1},d:function(t){re(e,t)}};return B("SvelteRegisterBlock",{block:s,id:Z.name,type:"if",source:"(59:2) {#if !$mod.fetching && !$mod.error && $mod.data.mod}",ctx:n}),s}function ve(n){let e=n[2].data.mod.name+"",r;const s={c:function(){r=j(e)},l:function(t){r=D(t,e)},m:function(t,a){T(t,r,a)},p:function(t,a){a&4&&e!==(e=t[2].data.mod.name+"")&&H(r,e)},d:function(t){t&&h(r)}};return B("SvelteRegisterBlock",{block:s,id:ve.name,type:"if",source:"(70:24) ",ctx:n}),s}function we(n){let e;const r={c:function(){e=j("...")},l:function(i){e=D(i,"...")},m:function(i,t){T(i,e,t)},p:L,d:function(i){i&&h(e)}};return B("SvelteRegisterBlock",{block:r,id:we.name,type:"if",source:"(68:2) {#if $mod.fetching}",ctx:n}),r}function be(n){let e,r,s,i;e=new ge({props:{onSubmit:n[8],modReference:n[2].data.mod.mod_reference},$$inline:!0});let t=n[3]&&Y(n);const a={c:function(){te(e.$$.fragment),r=z(),t&&t.c(),s=K()},l:function(o){ne(e.$$.fragment,o),r=A(o),t&&t.l(o),s=K()},m:function(o,p){oe(e,o,p),T(o,r,p),t&&t.m(o,p),T(o,s,p),i=!0},p:function(o,p){const $={};p&4&&($.modReference=o[2].data.mod.mod_reference),e.$set($),o[3]?t?t.p(o,p):(t=Y(o),t.c(),t.m(s.parentNode,s)):t&&(t.d(1),t=null)},i:function(o){i||(M(e.$$.fragment,o),i=!0)},o:function(o){C(e.$$.fragment,o),i=!1},d:function(o){re(e,o),o&&h(r),t&&t.d(o),o&&h(s)}};return B("SvelteRegisterBlock",{block:a,id:be.name,type:"else",source:"(81:4) {:else}",ctx:n}),a}function xe(n){let e,r,s=n[2].error.message+"",i;const t={c:function(){e=E("p"),r=j("Oh no... "),i=j(s),this.h()},l:function(u){e=I(u,"P",{});var o=V(e);r=D(o,"Oh no... "),i=D(o,s),o.forEach(h),this.h()},h:function(){R(e,N,79,6,2348)},m:function(u,o){T(u,e,o),y(e,r),y(e,i)},p:function(u,o){o&4&&s!==(s=u[2].error.message+"")&&H(i,s)},i:L,o:L,d:function(u){u&&h(e)}};return B("SvelteRegisterBlock",{block:t,id:xe.name,type:"if",source:"(79:25) ",ctx:n}),t}function ye(n){let e,r;const s={c:function(){e=E("p"),r=j("Loading..."),this.h()},l:function(t){e=I(t,"P",{});var a=V(e);r=D(a,"Loading..."),a.forEach(h),this.h()},h:function(){R(e,N,77,6,2298)},m:function(t,a){T(t,e,a),y(e,r)},p:L,i:L,o:L,d:function(t){t&&h(e)}};return B("SvelteRegisterBlock",{block:s,id:ye.name,type:"if",source:"(77:4) {#if $mod.fetching}",ctx:n}),s}function Y(n){let e,r,s,i,t,a,u,o,p=n[4].toFixed(0)+"",$,g,b,m,l;const w={c:function(){e=E("div"),r=E("div"),s=E("div"),i=E("span"),t=j(n[3]),a=z(),u=E("div"),o=E("span"),$=j(p),g=j("%"),b=z(),m=E("div"),l=E("div"),this.h()},l:function(d){e=I(d,"DIV",{class:!0});var x=V(e);r=I(x,"DIV",{class:!0});var k=V(r);s=I(k,"DIV",{});var c=V(s);i=I(c,"SPAN",{class:!0});var _=V(i);t=D(_,n[3]),_.forEach(h),c.forEach(h),a=A(k),u=I(k,"DIV",{class:!0});var G=V(u);o=I(G,"SPAN",{class:!0});var q=V(o);$=D(q,p),g=D(q,"%"),q.forEach(h),G.forEach(h),k.forEach(h),b=A(x),m=I(x,"DIV",{class:!0});var S=V(m);l=I(S,"DIV",{style:!0,class:!0}),V(l).forEach(h),S.forEach(h),x.forEach(h),this.h()},h:function(){F(i,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),R(i,N,87,14,2631),R(s,N,86,12,2611),F(o,"class","text-xs font-semibold inline-block text-white"),R(o,N,93,14,2879),F(u,"class","text-right"),R(u,N,92,12,2840),F(r,"class","flex mb-2 items-center justify-between"),R(r,N,85,10,2546),ue(l,"width",n[4].toFixed(0)+"%"),F(l,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),R(l,N,97,12,3105),F(m,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),R(m,N,96,10,3021),F(e,"class","relative pt-4"),R(e,N,84,8,2508)},m:function(d,x){T(d,e,x),y(e,r),y(r,s),y(s,i),y(i,t),y(r,a),y(r,u),y(u,o),y(o,$),y(o,g),y(e,b),y(e,m),y(m,l)},p:function(d,x){x&8&&H(t,d[3]),x&16&&p!==(p=d[4].toFixed(0)+"")&&H($,p),x&16&&ue(l,"width",d[4].toFixed(0)+"%")},d:function(d){d&&h(e)}};return B("SvelteRegisterBlock",{block:w,id:Y.name,type:"if",source:"(84:6) {#if $uploadStatus}",ctx:n}),w}function ke(n){let e,r;const s={c:function(){e=E("span"),r=j(n[1]),this.h()},l:function(t){e=I(t,"SPAN",{});var a=V(e);r=D(a,n[1]),a.forEach(h),this.h()},h:function(){R(e,N,108,2,3400)},m:function(t,a){T(t,e,a),y(e,r)},p:function(t,a){a&2&&H(r,t[1])},d:function(t){t&&h(e)}};return B("SvelteRegisterBlock",{block:s,id:ke.name,type:"slot",source:"(108:0) <Toast bind:running={errorToast}>",ctx:n}),s}function ee(n){let e,r,s,i,t,a,u,o,p,$,g,b,m,l=!n[2].fetching&&!n[2].error&&n[2].data.mod&&Z(n);function w(S,f){if(S[2].fetching)return we;if(!S[2].error)return ve}let v=w(n),d=v&&v(n);const x=[ye,xe,be],k=[];function c(S,f){return S[2].fetching?0:S[2].error?1:2}o=c(n),p=k[o]=x[o](n);function _(S){n[10](S)}let G={$$slots:{default:[ke]},$$scope:{ctx:n}};n[0]!==void 0&&(G.running=n[0]),g=new he({props:G,$$inline:!0}),Ie.push(()=>Ve(g,"running",_));const q={c:function(){l&&l.c(),e=K(),r=z(),s=E("h1"),i=j(`New Version for
  `),d&&d.c(),t=z(),a=E("div"),u=E("section"),p.c(),$=z(),te(g.$$.fragment),this.h()},l:function(f){const P=Te("svelte-nx2zao",document.head);l&&l.l(P),e=K(),P.forEach(h),r=A(f),s=I(f,"H1",{class:!0});var O=V(s);i=D(O,`New Version for
  `),d&&d.l(O),O.forEach(h),t=A(f),a=I(f,"DIV",{class:!0});var U=V(a);u=I(U,"SECTION",{});var ie=V(u);p.l(ie),ie.forEach(h),U.forEach(h),$=A(f),ne(g.$$.fragment,f),this.h()},h:function(){F(s,"class","text-4xl my-4 font-bold"),R(s,N,65,0,2083),R(u,N,75,2,2258),F(a,"class","card p-4"),R(a,N,74,0,2233)},m:function(f,P){l&&l.m(document.head,null),y(document.head,e),T(f,r,P),T(f,s,P),y(s,i),d&&d.m(s,null),T(f,t,P),T(f,a,P),y(a,u),k[o].m(u,null),T(f,$,P),oe(g,f,P),m=!0},p:function(f,[P]){!f[2].fetching&&!f[2].error&&f[2].data.mod?l?(l.p(f,P),P&4&&M(l,1)):(l=Z(f),l.c(),M(l,1),l.m(e.parentNode,e)):l&&(fe(),C(l,1,1,()=>{l=null}),le()),v===(v=w(f))&&d?d.p(f,P):(d&&d.d(1),d=v&&v(f),d&&(d.c(),d.m(s,null)));let O=o;o=c(f),o===O?k[o].p(f,P):(fe(),C(k[O],1,1,()=>{k[O]=null}),le(),p=k[o],p?p.p(f,P):(p=k[o]=x[o](f),p.c()),M(p,1),p.m(u,null));const U={};P&16386&&(U.$$scope={dirty:P,ctx:f}),!b&&P&1&&(b=!0,U.running=f[0],_e(()=>b=!1)),g.$set(U)},i:function(f){m||(M(l),M(p),M(g.$$.fragment,f),m=!0)},o:function(f){C(l),C(p),C(g.$$.fragment,f),m=!1},d:function(f){l&&l.d(f),h(e),f&&h(r),f&&h(s),d&&d.d(),f&&h(t),f&&h(a),k[o].d(),f&&h($),re(g,f)}};return B("SvelteRegisterBlock",{block:q,id:ee.name,type:"component",source:"",ctx:n}),q}function Oe(n,e,r){let s,i,t,{$$slots:a={},$$scope:u}=e;Re("Page",a,[]);let{data:o}=e;const{modId:p}=o,$=se(),g=J("");Q(g,"uploadStatus"),W(n,g,c=>r(3,i=c));const b=J(0);Q(b,"uploadPercent"),W(n,b,c=>r(4,t=c));const m=J();m.subscribe(c=>{c&&(c.uploaded===c.total?(g.set("Processing..."),b.set(100)):(g.set(`Uploading: ${c.uploaded}/${c.total}`),b.set(c.uploaded/c.total*100)))});let l="",w=!1;const v=X({query:de,client:$,variables:{mod:p}});Q(v,"mod"),W(n,v,c=>r(2,s=c));const d=async c=>me(c.file,s.data.mod.id,{changelog:c.changelog,stability:c.stability},m,$).then(_=>{console.log({success:_}),ae(ce+"/mod/"+p+"/version/"+_.version.id)}).catch(_=>{console.error(_),r(1,l="Error creating version: "+_.message),r(0,w=!0),g.set("")});n.$$.on_mount.push(function(){o===void 0&&!("data"in e||n.$$.bound[n.$$.props.data])&&pe.warn("<Page> was created without expected prop 'data'")});const x=["data"];Object.keys(e).forEach(c=>{!~x.indexOf(c)&&c.slice(0,2)!=="$$"&&c!=="slot"&&pe.warn(`<Page> was created with unknown prop '${c}'`)});function k(c){w=c,r(0,w)}return n.$$set=c=>{"data"in c&&r(9,o=c.data)},n.$capture_state=()=>({getContextClient:se,queryStore:X,Toast:he,goto:ae,VersionForm:ge,GetModReferenceDocument:de,writable:J,chunkedUpload:me,base:ce,MetaDescriptors:$e,data:o,modId:p,client:$,uploadStatus:g,uploadPercent:b,uploadState:m,errorMessage:l,errorToast:w,mod:v,onSubmit:d,$mod:s,$uploadStatus:i,$uploadPercent:t}),n.$inject_state=c=>{"data"in c&&r(9,o=c.data),"errorMessage"in c&&r(1,l=c.errorMessage),"errorToast"in c&&r(0,w=c.errorToast)},e&&"$$inject"in e&&n.$inject_state(e.$$inject),n.$$.update=()=>{n.$$.dirty&1&&(w||r(1,l=""))},[w,l,s,i,t,g,b,v,d,o,k]}class Ge extends Se{constructor(e){super(e),Pe(this,e,Oe,ee,Ee,{data:9}),B("SvelteRegisterComponent",{component:this,tagName:"Page",options:e,id:ee.name})}get data(){throw new Error("<Page>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set data(e){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Ge as component,Le as universal};
//# sourceMappingURL=17.d9c4bbab.js.map
