import{G as Z,S as De,i as Ce,d as B,s as Ne,v as Re,F as ue,a1 as Q,a2 as W,_ as me,$ as X,w as K,H as Y,a0 as je,f as pe,b as M,e as I,W as T,K as _e,j as h,k as U,g as E,h as V,X as z,M as ie,N as D,m as S,Q as y,n as C,Z as Fe,r as q,t as A,q as he,J as ee,L as te,O as oe,R as ne,p as ge,Y as L,u as G,l as ve}from"../chunks/vendor.339d1c7d.js";import{V as xe}from"../chunks/VersionForm.1b9a361d.js";import{w as Be,F as Oe,x as qe,y as Me,q as $e}from"../chunks/graphql.deb800f0.js";import{M as ye}from"../chunks/MetaDescriptors.d5a902ca.js";import{E as Ie}from"../chunks/EditCompatibilityForm.25530885.js";const Te=async({params:n})=>({...n}),Le=Object.freeze(Object.defineProperty({__proto__:null,load:Te},Symbol.toStringTag,{value:"Module"})),we=async(n,e,i,a,o)=>{const p=Math.ceil(n.size/1e7),d=new Array(p).fill(0).map((s,t)=>t).reverse(),l=(s,t,m)=>o.mutation(Me,{modId:e,versionId:m,part:t,file:s}).toPromise(),v=10;let w=0,f=0;const $=s=>{if(w>=v||!d.length)return;const t=d.pop(),m=t*1e7,b=n.slice(m,m+1e7);return w+=1,Promise.all([l(b,t+1,s).then(()=>(w-=1,a.set({total:p,uploaded:p-d.length-w}),$(s))).catch(x=>{if(console.error("Upload failed:",x),w-=1,d.push(t),f+=1,f<5)return $(s);throw new Error("Failed uploading after 5 attempts")}),$(s)])};return o.mutation(Be,{modId:e}).toPromise().then(async s=>(a.set({total:p,uploaded:0}),await $(s.data.createVersion),s.data.createVersion)).then(s=>(console.log("Finalizing",{versionID:s}),o.mutation(Oe,{modId:e,versionId:s,version:i}).toPromise().then(()=>new Promise((t,m)=>{let b=0,x=Z({query:qe,client:o,variables:{modId:e,versionId:s},requestPolicy:"network-only"});const u=setInterval(()=>{if(b==60)return clearInterval(u),m(new Error("Timed out waiting for mod processing"));x.pause(),x.resume(),b++},1e4),j=x.subscribe(P=>{if(!P.fetching){if(P.error){clearInterval(u),m(new Error(P.error.message)),setTimeout(j);return}P.data?.checkVersionUploadState?.version?.id&&(j(),clearInterval(u),t(P.data.checkVersionUploadState))}})})))).catch(s=>{throw console.error(s),s})},{console:be}=je,k="src/routes/mod/[modId]/new-version/+page.svelte";function re(n){let e,i;e=new ye({props:{description:"Creating a new version of mod "+n[0].data.mod.name,title:"New version of mod "+n[0].data.mod.name},$$inline:!0});const a={c:function(){ee(e.$$.fragment)},l:function(r){te(e.$$.fragment,r)},m:function(r,p){oe(e,r,p),i=!0},p:function(r,p){const d={};p&1&&(d.description="Creating a new version of mod "+r[0].data.mod.name),p&1&&(d.title="New version of mod "+r[0].data.mod.name),e.$set(d)},i:function(r){i||(q(e.$$.fragment,r),i=!0)},o:function(r){A(e.$$.fragment,r),i=!1},d:function(r){ne(e,r)}};return B("SvelteRegisterBlock",{block:a,id:re.name,type:"if",source:"(62:2) {#if !$mod.fetching && !$mod.error && $mod.data.mod}",ctx:n}),a}function Ee(n){let e=n[0].data.mod.name+"",i;const a={c:function(){i=T(e)},l:function(r){i=z(r,e)},m:function(r,p){C(r,i,p)},p:function(r,p){p&1&&e!==(e=r[0].data.mod.name+"")&&L(i,e)},d:function(r){r&&h(i)}};return B("SvelteRegisterBlock",{block:a,id:Ee.name,type:"if",source:"(74:26) ",ctx:n}),a}function Se(n){let e;const i={c:function(){e=T("...")},l:function(o){e=z(o,"...")},m:function(o,r){C(o,e,r)},p:G,d:function(o){o&&h(e)}};return B("SvelteRegisterBlock",{block:i,id:Se.name,type:"if",source:"(72:4) {#if $mod.fetching}",ctx:n}),i}function ke(n){let e,i,a,o,r,p="Edit Compatibility Info",d,l,v,w;e=new xe({props:{onSubmit:n[7],modReference:n[0].data.mod.mod_reference},$$inline:!0});let f=n[1]&&ae(n);v=new Ie({props:{mod:n[0].data.mod,modId:n[3]},$$inline:!0}),v.$on("fail",n[10]),v.$on("submit",n[11]);const $={c:function(){ee(e.$$.fragment),i=M(),f&&f.c(),a=M(),o=I("div"),r=I("span"),r.textContent=p,d=M(),l=I("div"),ee(v.$$.fragment),this.h()},l:function(t){te(e.$$.fragment,t),i=U(t),f&&f.l(t),a=U(t),o=E(t,"DIV",{class:!0});var m=V(o);r=E(m,"SPAN",{"data-svelte-h":!0}),ie(r)!=="svelte-d0elmi"&&(r.textContent=p),m.forEach(h),d=U(t),l=E(t,"DIV",{class:!0});var b=V(l);te(v.$$.fragment,b),b.forEach(h),this.h()},h:function(){S(r,k,136,8,3873),D(o,"class","p-4"),S(o,k,135,6,3847),D(l,"class","card p-4"),S(l,k,138,6,3929)},m:function(t,m){oe(e,t,m),C(t,i,m),f&&f.m(t,m),C(t,a,m),C(t,o,m),y(o,r),C(t,d,m),C(t,l,m),oe(v,l,null),w=!0},p:function(t,m){const b={};m&1&&(b.modReference=t[0].data.mod.mod_reference),e.$set(b),t[1]?f?f.p(t,m):(f=ae(t),f.c(),f.m(a.parentNode,a)):f&&(f.d(1),f=null);const x={};m&1&&(x.mod=t[0].data.mod),v.$set(x)},i:function(t){w||(q(e.$$.fragment,t),q(v.$$.fragment,t),w=!0)},o:function(t){A(e.$$.fragment,t),A(v.$$.fragment,t),w=!1},d:function(t){t&&(h(i),h(a),h(o),h(d),h(l)),ne(e,t),f&&f.d(t),ne(v)}};return B("SvelteRegisterBlock",{block:$,id:ke.name,type:"else",source:"(94:4) {:else}",ctx:n}),$}function Pe(n){let e,i,a=n[0].error.message+"",o;const r={c:function(){e=I("p"),i=T("Oh no... "),o=T(a),this.h()},l:function(d){e=E(d,"P",{});var l=V(e);i=z(l,"Oh no... "),o=z(l,a),l.forEach(h),this.h()},h:function(){S(e,k,110,6,2855)},m:function(d,l){C(d,e,l),y(e,i),y(e,o)},p:function(d,l){l&1&&a!==(a=d[0].error.message+"")&&L(o,a)},i:G,o:G,d:function(d){d&&h(e)}};return B("SvelteRegisterBlock",{block:r,id:Pe.name,type:"if",source:"(92:25) ",ctx:n}),r}function Ve(n){let e,i="Loading...";const a={c:function(){e=I("p"),e.textContent=i,this.h()},l:function(r){e=E(r,"P",{"data-svelte-h":!0}),ie(e)!=="svelte-qdsr2u"&&(e.textContent=i),this.h()},h:function(){S(e,k,108,6,2805)},m:function(r,p){C(r,e,p)},p:G,i:G,o:G,d:function(r){r&&h(e)}};return B("SvelteRegisterBlock",{block:a,id:Ve.name,type:"if",source:"(90:4) {#if $mod.fetching}",ctx:n}),a}function ae(n){let e,i,a,o,r,p,d,l,v=n[2].toFixed(0)+"",w,f,$,s,t;const m={c:function(){e=I("div"),i=I("div"),a=I("div"),o=I("span"),r=T(n[1]),p=M(),d=I("div"),l=I("span"),w=T(v),f=T("%"),$=M(),s=I("div"),t=I("div"),this.h()},l:function(x){e=E(x,"DIV",{class:!0});var u=V(e);i=E(u,"DIV",{class:!0});var j=V(i);a=E(j,"DIV",{});var P=V(a);o=E(P,"SPAN",{class:!0});var c=V(o);r=z(c,n[1]),c.forEach(h),P.forEach(h),p=U(j),d=E(j,"DIV",{class:!0});var F=V(d);l=E(F,"SPAN",{class:!0});var _=V(l);w=z(_,v),f=z(_,"%"),_.forEach(h),F.forEach(h),j.forEach(h),$=U(u),s=E(u,"DIV",{class:!0});var H=V(s);t=E(H,"DIV",{style:!0,class:!0}),V(t).forEach(h),H.forEach(h),u.forEach(h),this.h()},h:function(){D(o,"class","text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-white bg-yellow-600"),S(o,k,118,14,3138),S(a,k,117,12,3118),D(l,"class","text-xs font-semibold inline-block text-white"),S(l,k,124,14,3386),D(d,"class","text-right"),S(d,k,123,12,3347),D(i,"class","flex mb-2 items-center justify-between"),S(i,k,116,10,3053),ve(t,"width",n[2].toFixed(0)+"%"),D(t,"class","shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-600"),S(t,k,128,12,3612),D(s,"class","overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600"),S(s,k,127,10,3528),D(e,"class","relative pt-4"),S(e,k,115,8,3015)},m:function(x,u){C(x,e,u),y(e,i),y(i,a),y(a,o),y(o,r),y(i,p),y(i,d),y(d,l),y(l,w),y(l,f),y(e,$),y(e,s),y(s,t)},p:function(x,u){u&2&&L(r,x[1]),u&4&&v!==(v=x[2].toFixed(0)+"")&&L(w,v),u&4&&ve(t,"width",x[2].toFixed(0)+"%")},d:function(x){x&&h(e)}};return B("SvelteRegisterBlock",{block:m,id:ae.name,type:"if",source:"(97:6) {#if $uploadStatus}",ctx:n}),m}function se(n){let e,i,a,o,r,p,d,l,v="Return to Description Page (discard new version)",w,f,$,s,t,m,b,x,u=!n[0].fetching&&!n[0].error&&n[0].data.mod&&re(n);function j(N,g){if(N[0].fetching)return Se;if(!N[0].error)return Ee}let P=j(n),c=P&&P(n);const F=[Ve,Pe,ke],_=[];function H(N,g){return N[0].fetching?0:N[0].error?1:2}s=H(n),t=_[s]=F[s](n);const ce={c:function(){u&&u.c(),e=pe(),i=M(),a=I("div"),o=I("h1"),r=T(`New Version for
    `),c&&c.c(),p=M(),d=I("div"),l=I("button"),l.textContent=v,w=M(),f=I("div"),$=I("section"),t.c(),this.h()},l:function(g){const R=_e("svelte-nx2zao",document.head);u&&u.l(R),e=pe(),R.forEach(h),i=U(g),a=E(g,"DIV",{class:!0});var O=V(a);o=E(O,"H1",{class:!0});var J=V(o);r=z(J,`New Version for
    `),c&&c.l(J),J.forEach(h),p=U(O),d=E(O,"DIV",{});var le=V(d);l=E(le,"BUTTON",{class:!0,title:!0,"data-svelte-h":!0}),ie(l)!=="svelte-junll5"&&(l.textContent=v),le.forEach(h),O.forEach(h),w=U(g),f=E(g,"DIV",{class:!0});var fe=V(f);$=E(fe,"SECTION",{});var de=V($);t.l(de),de.forEach(h),fe.forEach(h),this.h()},h:function(){D(o,"class","text-4xl my-4 font-bold"),S(o,k,87,2,2325),D(l,"class","btn variant-ghost-primary"),D(l,"title","View the description page for this mod"),S(l,k,96,4,2500),S(d,k,95,2,2490),D(a,"class","flex flex-wrap h-auto justify-between items-center"),S(a,k,86,0,2258),S($,k,106,2,2765),D(f,"class","card p-4"),S(f,k,105,0,2740)},m:function(g,R){u&&u.m(document.head,null),y(document.head,e),C(g,i,R),C(g,a,R),y(a,o),y(o,r),c&&c.m(o,null),y(a,p),y(a,d),y(d,l),C(g,w,R),C(g,f,R),y(f,$),_[s].m($,null),m=!0,b||(x=Fe(l,"click",n[9],!1,!1,!1,!1),b=!0)},p:function(g,[R]){!g[0].fetching&&!g[0].error&&g[0].data.mod?u?(u.p(g,R),R&1&&q(u,1)):(u=re(g),u.c(),q(u,1),u.m(e.parentNode,e)):u&&(ge(),A(u,1,1,()=>{u=null}),he()),P===(P=j(g))&&c?c.p(g,R):(c&&c.d(1),c=P&&P(g),c&&(c.c(),c.m(o,null)));let O=s;s=H(g),s===O?_[s].p(g,R):(ge(),A(_[O],1,1,()=>{_[O]=null}),he(),t=_[s],t?t.p(g,R):(t=_[s]=F[s](g),t.c()),q(t,1),t.m($,null))},i:function(g){m||(q(u),q(t),m=!0)},o:function(g){A(u),A(t),m=!1},d:function(g){g&&(h(i),h(a),h(w),h(f)),u&&u.d(g),h(e),c&&c.d(),_[s].d(),b=!1,x()}};return B("SvelteRegisterBlock",{block:ce,id:se.name,type:"component",source:"",ctx:n}),ce}function Ue(n,e,i){let a,o,r,{$$slots:p={},$$scope:d}=e;Re("Page",p,[]);let{data:l}=e;const{modId:v}=l,w=ue(),f=K("");Q(f,"uploadStatus"),W(n,f,c=>i(1,o=c));const $=K(0);Q($,"uploadPercent"),W(n,$,c=>i(2,r=c));const s=K();s.subscribe(c=>{c&&(c.uploaded===c.total?(f.set("Processing..."),$.set(100)):(f.set(`Uploading: ${c.uploaded}/${c.total}`),$.set(c.uploaded/c.total*100)))});const t=me(),m=Z({query:$e,client:w,variables:{mod:v}});Q(m,"mod"),W(n,m,c=>i(0,a=c));const b=async c=>we(c.file,a.data.mod.id,{changelog:c.changelog,stability:c.stability},s,w).then(F=>{t.trigger({message:"Version created",background:"variant-filled-success",timeout:5e3}),X(Y+"/mod/"+v+"/version/"+F.version.id)}).catch(F=>{console.error(F),t.trigger({message:"Error creating version: "+F.message,background:"variant-filled-error",autohide:!1}),f.set("")});n.$$.on_mount.push(function(){l===void 0&&!("data"in e||n.$$.bound[n.$$.props.data])&&be.warn("<Page> was created without expected prop 'data'")});const x=["data"];Object.keys(e).forEach(c=>{!~x.indexOf(c)&&c.slice(0,2)!=="$$"&&c!=="slot"&&be.warn(`<Page> was created with unknown prop '${c}'`)});const u=()=>X(Y+"/mod/"+v),j=()=>{alert("Failed to update compatibility information, check browser console for more info.")},P=()=>{alert("Mod compatibility data updated. Don't forget to upload the version too!")};return n.$$set=c=>{"data"in c&&i(8,l=c.data)},n.$capture_state=()=>({getContextClient:ue,queryStore:Z,goto:X,VersionForm:xe,GetModDocument:$e,writable:K,chunkedUpload:we,base:Y,MetaDescriptors:ye,getToastStore:me,EditCompatibilityForm:Ie,data:l,modId:v,client:w,uploadStatus:f,uploadPercent:$,uploadState:s,toastStore:t,mod:m,onSubmit:b,$mod:a,$uploadStatus:o,$uploadPercent:r}),n.$inject_state=c=>{"data"in c&&i(8,l=c.data)},e&&"$$inject"in e&&n.$inject_state(e.$$inject),[a,o,r,v,f,$,m,b,l,u,j,P]}class Je extends De{constructor(e){super(e),Ce(this,e,Ue,se,Ne,{data:8}),B("SvelteRegisterComponent",{component:this,tagName:"Page",options:e,id:se.name})}get data(){throw new Error("<Page>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set data(e){throw new Error("<Page>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Je as component,Le as universal};
//# sourceMappingURL=17.af15ad78.js.map
